name: Build macOS (Intel) Binary

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-12
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # --- Install Homebrew dependencies manually ---
      - name: Install Homebrew ncurses and Python
        run: |
          brew update
          brew install ncurses python@3.11
          echo "HOMEBREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV
          echo "HOMEBREW_PYTHON=$(brew --prefix python@3.11)/bin/python3.11" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix ncurses)/lib/pkgconfig" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix ncurses)/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix ncurses)/include" >> $GITHUB_ENV
          echo "PATH=$(brew --prefix python@3.11)/bin:$PATH" >> $GITHUB_ENV

      # --- Use Homebrew Python explicitly ---
      - name: Verify Python & ncurses linkage
        run: |
          which $HOMEBREW_PYTHON
          $HOMEBREW_PYTHON -m sysconfig | grep ncurses || true
          $HOMEBREW_PYTHON -c "import curses; print('Has italics:', hasattr(curses, 'A_ITALIC'))"

      # --- Install dependencies using the Homebrew Python ---
      - name: Install dependencies
        run: |
          $HOMEBREW_PYTHON -m pip install --upgrade pip
          $HOMEBREW_PYTHON -m pip install pyinstaller

      # --- Build binary with the correct environment ---
      - name: Build binary
        run: |
          export PATH="$(brew --prefix python@3.11)/bin:$PATH"
          export LDFLAGS="-L$(brew --prefix ncurses)/lib"
          export CPPFLAGS="-I$(brew --prefix ncurses)/include"
          $HOMEBREW_PYTHON -m PyInstaller --onefile --name keyzerchief \
            --add-data "sfx:sfx" \
            keyzerchief

      - name: Prepare artifact
        run: |
          mkdir -p artifacts
          mv dist/keyzerchief artifacts/keyzerchief-macos-amd64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: keyzerchief-macos-amd64
          path: artifacts/keyzerchief-macos-amd64
          if-no-files-found: error

      - name: Publish release asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/keyzerchief-macos-amd64
